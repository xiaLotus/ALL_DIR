<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <title>ç™»å…¥æª¢æŸ¥ä¸­...</title>

    <!-- Tailwind -->
    <script src="static/js/tailwindcss.js"></script>

    <!-- Vue 3 -->
    <script src="static/js/vue.global.js"></script>

    <!-- SweetAlert2 -->
    <script src="static/js/sweetalert2@11.js"></script>

    <!-- Lucide icons -->
    <script src="static/js/lucide.js"></script>

</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

<div id="app">
    <div class="w-full flex flex-col items-center justify-center text-center select-none">

        <!-- åœ“å½¢ loading å‹•ç•« -->
        <div class="relative w-20 h-20 mb-6">
          <div class="absolute inset-0 rounded-full border-4 border-gray-300"></div>
          <div class="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
        </div>

        <!-- ä¸»æ¨™é¡Œ -->
        <h1 class="text-2xl font-bold text-gray-700 mb-2">
          å³å°‡é€²è¡Œè·³è½‰
        </h1>

        <!-- å‰¯æ¨™é¡Œ -->
        <p class="text-gray-500 text-base mb-4 animate-pulse">
          æ­£åœ¨æº–å‚™æ‚¨çš„ä½¿ç”¨ç’°å¢ƒâ€¦
        </p>

        <!-- å°æç¤º -->
        <div class="flex items-center gap-2 text-gray-600 text-sm mt-2">
          <i data-lucide="loader" class="w-4 h-4 animate-spin"></i>
          <span>è«‹ç¨å€™ç‰‡åˆ»</span>
        </div>

    </div>
</div>

<script>
const apiCheckUser = "http://10.11.104.247:8089/api/check_user";   // å·¥è™Ÿé©—è­‰
const dashboardUrl = "http://10.11.104.247:5002/dashboard";       // ç›®æ¨™é é¢

const app = Vue.createApp({
    data() {
        return {
            user: null,
        };
    },

    async mounted() {
        // åˆå§‹åŒ– icons
        this.$nextTick(() => {
            if (typeof lucide !== "undefined") lucide.createIcons();
        });

        // è®€å– SmartAgent å¡çš„ loggedUser
        this.user = localStorage.getItem("loggedUser");

        if (!this.user) {
            Swal.fire({
                icon: "error",
                title: "ç„¡æ³•å–å¾—ä½¿ç”¨è€…å¸³è™Ÿ",
                text: "è«‹é‡æ–°ç™»å…¥ Windows å¸³è™Ÿå¾Œå†è©¦ã€‚",
                confirmButtonColor: "#d33"
            });
            return;
        }

        // Step 1ï¼šæŸ¥å·¥è™Ÿæ˜¯å¦å­˜åœ¨æ–¼ emoinfo.json
        let check;
        try {
            const res = await fetch(`${apiCheckUser}?user=${this.user}`);
            check = await res.json();
        } catch (err) {
            return this.errorJump(
                "å¾Œç«¯ API ç„¡æ³•é€£ç·š",
                `ç„¡æ³•é€£ç·šè‡³é©—è­‰ä¼ºæœå™¨<br>è«‹ç¢ºèªç¶²è·¯æˆ–æ‰¾ <b>K22920</b> å”åŠ©ï¼ˆä½†ä»–å¯èƒ½ä¹Ÿä¸çŸ¥é“ ğŸ˜„ï¼‰`
            );
        }

        // ç„¡æ¬Šé™ â†’ é€€å› myasex
        if (check.status !== "ok") {
            return this.errorJump(
                "æ­¤å¸³è™Ÿç„¡æ³•ç™»å…¥æ­¤ç¶²åŸŸ",
                `å·¥è™Ÿï¼š${this.user}<br>å¦‚éœ€å”åŠ©è«‹æ‰¾ <b>K22920</b>ï¼ˆä½†ä»–å¯èƒ½ä¹Ÿä¸çŸ¥é“ ğŸ˜„ï¼‰`
            );
        }

        // â­ Step 2ï¼šæˆåŠŸ â†’ å¯«å…¥ localStorage (ä¸ç™»å…¥å¾Œç«¯)
        localStorage.setItem("username", this.user);
        localStorage.setItem("loggedUser", this.user);

        // â­ Step 3ï¼šå›ºå®š 2 ç§’å¾Œè·³è½‰ dashboard
        const encodedUser = encodeURIComponent(this.user);
        const targetUrl = `${dashboardUrl}?user=${encodedUser}`;

        setTimeout(() => {
            window.location.replace(targetUrl);

            // Edge fallback
            setTimeout(() => {
                window.location.href = targetUrl;
            }, 300);

            // ä¿åº•åˆ·æ–°
            document.head.insertAdjacentHTML(
                "beforeend",
                `<meta http-equiv="refresh" content="1; url=${targetUrl}">`
            );
        }, 2000);
    },

    methods: {
        // Swal + è‡ªå‹•è·³è½‰ myasex
        errorJump(title, html) {
            Swal.fire({
                icon: "error",
                title,
                html: `${html}<br><span class="text-red-600 text-sm">2 ç§’å¾Œå°‡è‡ªå‹•è·³è½‰é¦–é â€¦</span>`,
                confirmButtonColor: "#d33",
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    setTimeout(() => {
                        window.location.href = "https://myasex.kh.asegroup.com";
                    }, 2000);
                }
            });
        }
    }
});

app.mount("#app");
</script>

</body>
</html>
